## TIGAR
**TIGAR** standing for **Transcriptome-Intergrated Genetic Association Resource**, which is developed using *Python* and *BASH* scripts. 

1. **TIGAR** can fit both **Elastic-Net** and **nonparametric Beyesian Dirichlet Process Regression (DPR)** models for predicting gene expression with reference panel.
2. Impute **Genetically Regulated gene eXpression (GReX)** from *Individual-level* genotype data
3. Conduct **Transcriptome-Wide Association Studies (TWAS)** using both *Individual-level* and *Summary-level* GWAS data for *Univariate* and *Multivariate* phenotypes.

### Software Setup

#### 1. Setup Executable Files
- Change all `*.sh` and `*.py` files into executable files
	```
	chmod 755 *.sh ./Model_Train_Pred/*.sh ./Model_Train_Pred/*.py ./Model_Train_Pred/DPR ./TWAS/*.sh ./TWAS/*.py
	```
- Add the executable file `./Model_Train_Pred/DPR` to your linux `${PATH}` directory. 
	Assuming `~/bin/` is a directory added to your `${PATH}` environmental variable, you can accomodate the following example command
	```
	cp ./Model_Train_Pred/DPR ~/bin/
	```

#### 2. Install BGZIP, TABIX, Python 3.5 and the following python libraries
- BGZIP: http://www.htslib.org/doc/bgzip.html 
- TABIX: http://www.htslib.org/doc/tabix.html 
- python 3.5 
   - dfply
   - io
   - subprocess
   - multiprocess

### Input File Format
Example data provided here are generated artificially. All input files are **Tab Delimited Text Files**.


#### 1. Gene Expression File (`./example_data/Gene_Exp.txt`)
- First 5 columns specify chromosome number, gene start position, gene end position, target gene ID, gene name (optional, could be the same as gene ID).
- Sample gene expression data start from the 6th column. 

| CHROM | GeneStart | GeneEnd |   TargetID      | GeneName | sample1 | sample...|
|:-----:|:---------:|:-------:|:---------------:|:--------:|:-------:|:--------:|
|   1   |    100    |   200   |     ENSG0000    |     X    |   0.2   |     ...  |


#### 2. Genotype File
	i. VCF file (`./example_data/example.vcf.gz`)

		- Sorted by chromosome and base pair position, zipped by `bgzip`, and tabixed.
		- Example tabix commond, `tabix -f -p vcf *.vcf.gz`.
		- Genotype data start from the 10th column.
		- More information about VCF file format: http://www.internationalgenome.org/wiki/Analysis/Variant%20Call%20Format/vcf-variant-call-format-version-40/

		| CHROM | POS |  ID | REF | ALT | QUAL | FILTER | INFO | FORMAT |  sample1 | sample...|
		|:-----:|:---:|:---:|:---:|:---:|:----:|:------:|:----:|:------:|:--------:|:--------:|
		|   1   | 100 | rs1 |  C  |  T  |   .  |  PASS  |   .  |  GT:DS | 0/0:0.01 |    ...   |

	ii. Dosage file

		- The first 5 columns are of the same format as VCF file.
		- Dosage genotype data start from the 6th column.

		| CHROM | POS |  ID | REF | ALT | sample1 | sample...|
		|:-----:|:---:|:---:|:---:|:---:|:-------:|:--------:|
		|   1   | 100 | rs1 |  C  |  T  |   0.01  |    ...   |

#### 3. PED File (`./example_data/example_PED.ped`)
- More informationa bout PED file format: http://zzz.bwh.harvard.edu/plink/data.shtml#ped

| FAM_ID | IND_ID | FAT_ID | MOT_ID | SEX | PHENO | COV1 | COV...|
|:------:|:------:|:------:|:------:|:---:|:-----:|:---:|:---:|
|   11A  |   11A  |    X   |    X   |  1  |  0.2  | 0.3 |...|

#### 4. Asso_Info file (`./example_data/Asso_Info_*.txt`)
- Two columns with the first column specifying the Phenotype (P) and Covariate variables (C) from the PED file, and the second column specifying the corresponding variable names in the PED file. The variables specified in the Asso_Info file will be used in TWAS.

|P|PHENO|
|:-----:|:---:|
|C|COV1|
|C|COV2|
|C|SEX|

#### 5.Zscore File (`./example_data/CHR1_GWAS_Zscore.txt.gz`)
- Sorted by chromosome and base pair position, zipped by `bgzip`, and tabixed
- Example tabix commond, `tabix -f -p vcf *_Zscore.txt.gz`. The first 4 columns are of the same format as VCF file.

| CHROM | POS | REF | ALT | Zscore |
|:-----:|:---:|:---:|:---:|:------:|
|   1   | 100 |  C  |  T  |  0.01  |

#### 6. Genome block annotation file (`./example_data/block_annotation_EUR.txt`)
- The block annotation file is a tab delimited text file with head row of `CHROM Start End File`, denoting the chromosome number, starting position, ending position, and corresponding reference VCF file name under specified `--geno_path`. Reference VCF files shall be of one per chromosome, or one for the whole genome-wide variants. Example block annotation file for European samples is provided `./TIGAR/example_data/block_annotation_EUR.txt`. 

| CHROM |   Start   |    End  |        File     |
|:-----:|:---------:|:-------:|:---------------:|
|   1   |    100    | 20000   |  CHR1.vcf.gz    |

- Block annotation files of other ethnicities can be adopted from the genome segmentation generated by `LDetect`, https://bitbucket.org/nygcresearch/ldetect-data/src/master/.

#### 7. Gene Annotation File (`./example_data/Gene_annotation.txt`)
- The same format as the first five columns of the Gene Expression File.

| CHROM | GeneStart | GeneEnd |     TargetID    | GeneName | 
|:-----:|:---------:|:-------:|:---------------:|:--------:|
|   1   |    100    |   200   |     ENSG0000    |     X    |

#### 8. Weight File used for TWAS with GWAS summary statistics (`./example_data/weight.txt`)
- First 5 columns have to be of the following format, specifying chromosome number, base pair position, reference allele, alternative allele, and target gene ID. 

- The column `ES` (Effect Size) denotes the weights for this given SNP/TargetGene


| CHROM | POS | REF | ALT |     TargetID    |  ES  |
|:-----:|:---:|:---:|:---:|:---------------:|:----:|
|   1   | 100 |  C  |  T  |     ENSG0000    |  0.2 |


### Example Usage 
#### 1. Train gene expression prediction models per chromosome using reference data that have both profiled gene expression and genotype data of the same samples

- Variables to specify
	- `--model`: Gene expression prediction model: `elastic_net` or `DPR`
	- `--Gene_Exp`: Path for Gene annotation and Expression file
	- `--train_sampleID`: Path for a file with sampleIDs that will be used for training
	- `--genofile`: Path for the training genotype file (bgzipped and tabixed) 
	- `--chr`: Chromosome number need to be specified with respect to the genotype input data (default: `1`)
	- `--genofile_tye`: Genotype file type: `vcf` or `dosage`
	- `--Format`: Genotype format in VCF file that should be used: `GT` (default) for genotype data or `DS` for dosage data, only required if the input genotype file is of VCF file
	- `--maf`: Minor Allele Frequency threshold (ranges from 0 to 1; default `0.01`) to exclude rare variants
	- `--hwe`: Hardy Weinberg Equilibrium p-value threshold (default `0.00001`) to exclude variants that violated HWE
	- `--window`: Window size around gene transcription starting sites (TSS) for selecting cis-SNPs for fitting gene expression prediction model (default `1000000` for +- 1MB region around TSS)
	- `--thread`: Number of threads for parallel computation (default `1`)
	- `--out`: Output directory (will be created if not exist)


- Train nonparametric Bayesian DPR prediction model

	- Variables to specify for training nonparametric Bayesian DPR prediction model
		- `--dpr`: Bayesian inference algorithm used by DPR: `1` (Variational Bayesian) or `2` (MCMC)
		- `--ES`: Output effect size type: `fixed` (default) for fixed effects or `additive` for addition of fixed and random effects
	- Example bash command
			```
			./TIGAR_Model_Train.sh --model DPR \
			--Gene_Exp ${Gene_Exp_train_file} --train_sample ${train_sample_path} \
			--chr 1 --train_dir ${train_dir} \
			--geno_train vcf --FT DS \
			--out ${out_prefix}
			```

- Train Elastic-Net prediction model
	- Variables to specify for training Elastic-Net prediction model
		- `--cv`: Number of cross validation folds for tuning elastic-net penalty parameter (default `5`)
		- `--alpha`: Fixed L1 & L2 penalty ratio for elastic-net model (default `0.5`)
			- If alpha=0, equivalent to lasso regression
			- If alpha=1, equivalent to ridge regression

	- Example bash command
			```
			./TIGAR_Model_Train.sh --model elastic_net \
			--Gene_Exp ${Gene_Exp_train_file} --train_sample ${train_sample_path} \
			--chr 1 --train_dir ${train_dir} \
			--geno_train vcf --FT DS \
			--out ${out_prefix}
			```


#### 2. Predict GReX
```
./TIGAR_Model_Pred.sh --chr 1 \
--train_result_path ${train_result_path} \
--train_info_path ${train_info_path} \
--genofile_dir ${genofile_dir} \
--genofile_type vcf --Format GT \
--out ${out_prefix}
```

#### 3. TWAS

Using individual-level GWAS data. Take the output `*_GReX_prediction.txt` from gene expression prediction as the input for `--Gene_EXP` here. 
```
./TIGAR_TWAS.sh --asso 1 \
--Gene_EXP ${Gene_Exp_prediction_file} --PED ${PED} --Asso_Info ${asso_Info} \
--out ${out_prefix}
```

Using summary-level GWAS data. Take the output `*_training_param.txt` from imputation model training as the input Weight file here. The first five columns of the gene expression file will be taken as gene annotation file here for `--Gene_anno`. The same gene expression file can be used as input for `--Gene_anno`. 

```
./TIGAR_TWAS.sh --asso 2 \
--Gene_anno ${Gene_anno_file} --Zscore ${Zscore} --Weight ${Weight} \
--Covar ${Ref_Covariance_file} --chr 22 \
--out ${out_prefix}
```

#### 4. Generate reference covariance files
```
.TIGAR_Covar.sh --block ${block_annotation} \
--geno_path ${geno_path} --geno vcf \
--chr 22 --Format GT \
--out ${out_prefix}
```

### Reference
- Elastic Net: https://github.com/hakyimlab/PrediXcan  
- DPR: https://github.com/biostatpzeng/DPR
